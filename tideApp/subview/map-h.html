<!doctype html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
	    <title>潮汐停车</title>
	    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
	    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
	    <script src="http://webapi.amap.com/maps?v=1.3&key=您申请的key值"></script>
	    <style type="text/css">
			#map{
				width: 100%;
				position: fixed;
				left: 0px;
				top: 0px;
				bottom: 0px;
				line-height: 200px;
				text-align: center;
				background: #FFFFFF;
			}
		</style>
	</head>
	<body>
		<div id="map">地图加载中...</div>
		<script src="../js/mui.min.js"></script>
		<script>
			var ws=null,wo=null;
			var em=null,map=null,pcenter=null;
			var wMarkSub=null;
			// H5 plus事件处理
			function plusReady(){
				if(!em||ws){return};
				// 获取窗口对象
				ws=plus.webview.currentWebview();
				wo=ws.opener();
				
				setTimeout(function(){
					map = new AMap.Map('map', {
				        resizeEnable: true,
				        zoom:16
				    });
					createMarker();
					// 创建子窗口
					//createSearchSubview();
					//userLocation();
//					map.onclick = function( point ){
//						if(wMarkSub != null){
//							ws.remove(wMarkSub);
//							//wMarkSub.close();
//						}
//					}
				},300);
				// 显示页面并关闭等待框
			    ws.show("pop-in");
			}
			
			if(window.plus){
				plusReady();
			}else{
				document.addEventListener("plusready",plusReady,false);
			}
			
			// DOMContentloaded事件处理
			document.addEventListener("DOMContentLoaded",function(){
				em=document.getElementById("map");
				window.plus&&plusReady();
			},false);
			
		    function userLocation(){
				map.showUserLocation( true );
				map.getUserLocation(function(state,pos){
					if(0==state){
						map.setCenter(pos);
					}
				});
			}
		    
			function createMarker(){
				var markers = '{"markers":[{"lat":"38.0407702774249","lng":"114.523514","title":"全通停车场","addr":"石家庄市青园街220号"}]}';
				addMarkers(JSON.parse(markers));
			}
			
			function addMarkers(markers){
			    for(var i = 0; i < markers.markers.length; i++){
			    	var marker = new AMap.Marker({
			            position: [markers.markers[i].lng,markers.markers[i].lat],
			            icon: 'http://127.0.0.1:8020/ChaoXiApp/image/mark48.png'
			        });
			        marker.setMap(map);
			    }
			}
			
			function createMarkSubview(marker){
				console.log(marker);
				var bottomoffset='1px';
				if(plus.navigator.isImmersedStatusbar()){// 兼容immersed状态栏模式
					topoffset=(Math.round(plus.navigator.getStatusbarHeight())+1)+'px';
				}
				if(wMarkSub == null){
					wMarkSub=plus.webview.create('maps_mark_sub.html','mark',{bottom:bottomoffset,height:'160px',position:'absolute',scrollIndicator:'none',background:'transparent'},{marker:marker});
					ws.append(wMarkSub);
				}
			}
			
			function createSearchSubview(){
				// 创建加载内容窗口
				var topoffset='4px';
				if(plus.navigator.isImmersedStatusbar()){// 兼容immersed状态栏模式
					topoffset=(Math.round(plus.navigator.getStatusbarHeight())+44)+'px';
				}
				var wsub=plus.webview.create('maps_search_sub.html','sub',{top:topoffset,height:'50px',position:'absolute',scrollIndicator:'none',background:'transparent'});
				ws.append(wsub);
			}
		    
		
		</script>
	</body>
</html>